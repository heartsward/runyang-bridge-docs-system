# 润扬大桥运维文档管理系统 - 系统架构文档

## 📋 目录
- [系统概述](#系统概述)
- [技术架构](#技术架构)
- [核心模块](#核心模块)
- [数据库设计](#数据库设计)
- [API接口](#api接口)
- [安全机制](#安全机制)
- [部署架构](#部署架构)

## 🏗️ 系统概述

### 系统定位
润扬大桥运维文档管理系统是一个专为桥梁运维管理设计的现代化文档管理平台，集成了文档管理、资产管理、智能搜索、用户行为分析等核心功能。

### 设计理念
- **智慧运维**：通过AI分析提供运维建议
- **数据驱动**：基于用户行为优化系统功能
- **安全可靠**：多层安全防护，数据持久化存储
- **易用高效**：直观的用户界面，快速的搜索响应

## 🏛️ 技术架构

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端展示层    │ ←→ │   后端服务层    │ ←→ │   数据存储层    │
│                 │    │                 │    │                 │
│ Vue 3 + TS      │    │ FastAPI + Python│    │ SQLite + JSON   │
│ Naive UI        │    │ SQLAlchemy      │    │ 文件系统        │
│ Vite            │    │ JWT认证         │    │ 日志文件        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术栈详情

#### 前端技术栈
- **框架**: Vue 3 (Composition API)
- **语言**: TypeScript
- **构建工具**: Vite 4
- **UI组件库**: Naive UI
- **状态管理**: Vue 3 Composition API
- **HTTP客户端**: Axios
- **图标库**: @vicons/ionicons5, @vicons/antd
- **路由**: Vue Router 4

#### 后端技术栈
- **框架**: FastAPI 0.104+
- **语言**: Python 3.8+
- **ORM**: SQLAlchemy 2.0
- **数据库**: SQLite (生产可扩展至PostgreSQL)
- **认证**: JWT (PyJWT)
- **密码加密**: Bcrypt
- **文档处理**: PyPDF2, python-docx, openpyxl, LibreOffice
- **Web服务器**: Uvicorn
- **跨域处理**: FastAPI CORS

#### 数据存储
- **主数据库**: SQLite (yunwei_docs_clean.db)
- **用户数据**: JSON文件持久化 (users_data.json)
- **资产数据**: JSON文件持久化 (assets_data.json)
- **分析数据**: JSON文件持久化 (user_analytics_data.json)
- **文件存储**: 本地文件系统 (./uploads/)

## 🔧 核心模块

### 1. 用户认证模块
**位置**: `backend/database_integrated_server.py:578-609`
- JWT Token生成与验证
- 基于角色的访问控制 (RBAC)
- 用户状态管理
- 密码安全存储

### 2. 文档管理模块
**位置**: `backend/database_integrated_server.py:611-931`
- 文档上传与存储
- 内容异步提取
- 文档预览与下载
- 元数据管理 (标题、描述、标签)
- 文件类型验证

### 3. 智能搜索模块
**位置**: `backend/database_integrated_server.py:1017-1364`
- 全文搜索引擎
- 多字段权重搜索
- 内容高亮显示
- 搜索建议
- 搜索统计分析

### 4. 资产管理模块
**位置**: `backend/database_integrated_server.py:1963-2313`
- 资产CRUD操作
- 资产分类与统计
- 资产导出功能
- 从文档提取资产信息
- 资产查看追踪

### 5. 数据分析模块
**位置**: `backend/database_integrated_server.py:1443-2685`
- 用户行为追踪
- 访问统计分析
- AI智能分析
- 运维建议生成
- 数据可视化支持

### 6. 任务管理模块
**位置**: `backend/database_integrated_server.py:323-540`
- 异步任务处理
- 内容提取任务
- 任务状态追踪
- 错误处理与重试

## 💾 数据库设计

### 主要实体关系
```
Users (用户表)
├── Documents (文档表) - 1:N
├── Assets (资产表) - 1:N
└── ActivityLogs (活动日志) - 1:N

Documents (文档表)
├── file_path: 文件路径
├── content: 提取的文本内容
├── tags: 标签数组
└── metadata: 元数据

Assets (资产表)
├── device_info: 设备信息
├── network_config: 网络配置
└── status: 运行状态
```

### 数据持久化策略
1. **关系数据**: SQLite数据库存储
2. **用户数据**: JSON文件持久化，支持热重载
3. **分析数据**: 实时统计，定时持久化
4. **文件数据**: 文件系统存储，数据库记录路径

## 🔌 API接口

### 认证接口
- `POST /api/v1/auth/login` - 用户登录
- `GET /api/v1/auth/me` - 获取用户信息

### 文档管理接口
- `POST /api/v1/upload` - 上传文档
- `GET /api/v1/documents` - 获取文档列表
- `GET /api/v1/documents/{id}` - 获取文档详情
- `PUT /api/v1/documents/{id}` - 更新文档
- `DELETE /api/v1/documents/{id}` - 删除文档
- `GET /api/v1/documents/{id}/download` - 下载文档

### 搜索接口
- `POST /api/v1/search` - 智能搜索
- `GET /api/v1/search/documents` - 文档搜索
- `GET /api/v1/search/preview/{id}` - 文档预览
- `GET /api/v1/search/suggestions` - 搜索建议

### 资产管理接口
- `GET /api/v1/assets` - 获取资产列表
- `POST /api/v1/assets` - 创建资产
- `GET /api/v1/assets/{id}` - 获取资产详情
- `PUT /api/v1/assets/{id}` - 更新资产
- `DELETE /api/v1/assets/{id}` - 删除资产
- `POST /api/v1/assets/extract` - 从文档提取资产

### 分析统计接口
- `GET /api/v1/analytics/stats` - 系统统计
- `GET /api/v1/analytics/ai-analysis` - AI分析
- `POST /api/v1/analytics/clear-stats` - 清空统计

### 用户管理接口 (管理员)
- `GET /api/v1/settings/users` - 获取用户列表
- `POST /api/v1/settings/users` - 创建用户
- `PUT /api/v1/settings/users/{id}` - 更新用户
- `DELETE /api/v1/settings/users/{id}` - 删除用户

## 🔐 安全机制

### 认证安全
- **JWT Token**: 24小时过期，支持刷新
- **密码存储**: Bcrypt哈希加密
- **会话管理**: 无状态认证，支持多端登录

### 授权控制
- **角色权限**: 普通用户 vs 管理员
- **接口保护**: 基于装饰器的权限验证
- **资源隔离**: 用户只能访问授权资源

### 数据安全
- **文件验证**: 严格的文件类型和大小限制
- **SQL注入防护**: SQLAlchemy ORM防护
- **XSS防护**: 输入数据清理和转义
- **CORS配置**: 生产环境跨域限制

### 系统安全
- **错误处理**: 统一异常处理，避免信息泄露
- **日志审计**: 关键操作日志记录
- **数据备份**: 定期数据备份机制

## 🚀 部署架构

### 单机部署 (当前)
```
┌─────────────────────────────────┐
│        运行环境 (服务器)         │
├─────────────────────────────────┤
│ 前端服务 (端口: 5173)           │
│ ├── Vite Dev Server             │
│ └── 静态资源服务                │
├─────────────────────────────────┤
│ 后端服务 (端口: 8002)           │
│ ├── FastAPI应用                 │
│ ├── Uvicorn服务器               │
│ └── 异步任务处理                │
├─────────────────────────────────┤
│ 数据存储                        │
│ ├── SQLite数据库                │
│ ├── JSON配置文件                │
│ ├── 上传文件目录                │
│ └── 系统日志                    │
└─────────────────────────────────┘
```

### 扩展部署建议 (未来)
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   负载均衡  │    │   应用服务  │    │   数据服务  │
│             │    │             │    │             │
│ Nginx       │ ←→ │ FastAPI     │ ←→ │ PostgreSQL  │
│ 静态资源    │    │ Redis缓存   │    │ 文件存储    │
│ SSL终结     │    │ 任务队列    │    │ 日志系统    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 容器化部署
- **Docker支持**: 提供Dockerfile
- **容器编排**: docker-compose配置
- **环境隔离**: 开发/测试/生产环境分离
- **自动化部署**: CI/CD流水线支持

## 📊 性能特性

### 前端优化
- **代码分割**: 按路由和组件分割
- **懒加载**: 组件和资源按需加载
- **缓存策略**: 浏览器和服务端缓存
- **包大小优化**: Tree-shaking和压缩

### 后端优化
- **异步处理**: 文档处理不阻塞主线程
- **数据库优化**: 索引和查询优化
- **内存管理**: 大文件流式处理
- **并发处理**: FastAPI异步支持

### 数据优化
- **分页查询**: 大数据集分页处理
- **缓存机制**: 热点数据内存缓存
- **压缩存储**: 文件和数据压缩
- **索引优化**: 搜索性能优化

---

*本文档持续更新，版本: 1.0.0*
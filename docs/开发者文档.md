# 润扬大桥运维文档管理系统 - 开发者文档

## 📋 目录
- [开发环境搭建](#开发环境搭建)
- [项目结构](#项目结构)
- [前端开发](#前端开发)
- [后端开发](#后端开发)
- [API文档](#api文档)
- [数据库设计](#数据库设计)
- [测试指南](#测试指南)
- [部署指南](#部署指南)
- [贡献指南](#贡献指南)

## 🛠️ 开发环境搭建

### 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python**: 3.8+ 
- **Node.js**: 16+
- **LibreOffice**: 最新版本 (文档内容提取必需)
- **Git**: 最新版本

### 快速开始
```bash
# 1. 安装LibreOffice (必需)
# Windows: https://www.libreoffice.org/download/download/
# Ubuntu/Debian: sudo apt install libreoffice
# macOS: brew install --cask libreoffice

# 2. 克隆项目
git clone <repository-url>
cd yunweiruanjian

# 3. 安装后端依赖
cd backend
pip install -r requirements.txt

# 4. 安装前端依赖
cd ../frontend
npm install

# 5. 启动后端 (终端1)
cd ../backend
python database_integrated_server.py

# 6. 启动前端 (终端2)
cd ../frontend
npm run dev
```

### 开发工具推荐
- **IDE**: VS Code, PyCharm, WebStorm
- **Python插件**: Python, Pylance
- **前端插件**: Vetur, TypeScript Vue Plugin
- **调试工具**: Chrome DevTools, Vue DevTools

## 📁 项目结构

```
yunweiruanjian/
├── backend/                    # 后端代码
│   ├── app/                   # 应用核心
│   │   ├── api/              # API路由
│   │   ├── core/             # 核心配置
│   │   ├── crud/             # 数据操作
│   │   ├── db/               # 数据库配置
│   │   ├── models/           # 数据模型
│   │   ├── schemas/          # Pydantic模式
│   │   └── services/         # 业务服务
│   ├── database_integrated_server.py  # 主服务器
│   ├── requirements.txt      # Python依赖
│   └── .env.production      # 生产环境配置
├── frontend/                  # 前端代码
│   ├── src/                  # 源代码
│   │   ├── components/       # Vue组件
│   │   ├── views/           # 页面视图
│   │   ├── router/          # 路由配置
│   │   ├── stores/          # 状态管理
│   │   ├── utils/           # 工具函数
│   │   └── assets/          # 静态资源
│   ├── public/              # 公共资源
│   ├── package.json         # 前端依赖
│   ├── vite.config.ts       # Vite配置
│   └── .env.production      # 生产环境配置
├── docs/                     # 文档目录
├── logs/                     # 运行日志
├── uploads/                  # 上传文件
├── README.md                # 项目说明
├── start-production.bat     # Windows启动脚本
├── start-production.sh      # Linux/macOS启动脚本
└── stop-services.*          # 停止服务脚本
```

## 🎨 前端开发

### 技术栈
- **Vue 3**: 使用Composition API
- **TypeScript**: 类型安全
- **Vite**: 快速构建工具
- **Naive UI**: 组件库
- **Vue Router**: 路由管理
- **Axios**: HTTP客户端

### 核心组件

#### 1. 布局组件
**文件**: `src/components/EnhancedLayout.vue`
```vue
<template>
  <n-layout>
    <n-layout-header>
      <!-- 顶部导航 -->
    </n-layout-header>
    <n-layout>
      <n-layout-sider>
        <!-- 侧边菜单 -->
      </n-layout-sider>
      <n-layout-content>
        <!-- 主要内容 -->
        <router-view />
      </n-layout-content>
    </n-layout>
  </n-layout>
</template>
```

#### 2. 文档组件
**文件**: `src/views/DocumentView.vue`
- 文档列表展示
- 文档上传功能
- 文档预览功能
- 搜索和筛选

#### 3. 搜索组件
**文件**: `src/views/SearchView.vue`
- 智能搜索界面
- 结果展示和高亮
- 分页和排序

### 状态管理
使用Vue 3 Composition API进行状态管理：

```typescript
// stores/user.ts
import { ref, computed } from 'vue'

export const useUserStore = () => {
  const user = ref(null)
  const isLoggedIn = computed(() => !!user.value)
  
  const login = async (credentials) => {
    // 登录逻辑
  }
  
  return {
    user,
    isLoggedIn,
    login
  }
}
```

### 路由配置
**文件**: `src/router/index.ts`
```typescript
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/',
    name: 'Home',
    component: () => import('../views/HomeView.vue')
  },
  {
    path: '/documents',
    name: 'Documents',
    component: () => import('../views/DocumentView.vue'),
    meta: { requiresAuth: true }
  }
]

export default createRouter({
  history: createWebHistory(),
  routes
})
```

### API调用
**文件**: `src/utils/api.ts`
```typescript
import axios from 'axios'

const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000
})

// 请求拦截器
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

export default api
```

### 组件开发规范
1. **文件命名**: 使用PascalCase，如`DocumentList.vue`
2. **组件结构**: 
   ```vue
   <script setup lang="ts">
   // 逻辑代码
   </script>
   
   <template>
   <!-- 模板代码 -->
   </template>
   
   <style scoped>
   /* 样式代码 */
   </style>
   ```
3. **类型定义**: 使用TypeScript定义接口
4. **响应式数据**: 使用ref/reactive管理状态

## 🚀 后端开发

### 技术栈
- **FastAPI**: 现代Python Web框架
- **SQLAlchemy**: ORM框架
- **Pydantic**: 数据验证
- **Alembic**: 数据库迁移
- **JWT**: 身份认证

### 项目架构

#### 1. 应用结构
```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(
    title="润扬大桥运维文档管理系统",
    version="1.0.0"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 2. 数据模型
**文件**: `app/models/document.py`
```python
from sqlalchemy import Column, Integer, String, Text, DateTime, Boolean
from app.db.database import Base

class Document(Base):
    __tablename__ = "documents"
    
    id = Column(Integer, primary_key=True, index=True)
    title = Column(String, index=True)
    description = Column(Text)
    file_path = Column(String)
    content = Column(Text)
    content_extracted = Column(Boolean, default=False)
    created_at = Column(DateTime)
    updated_at = Column(DateTime)
```

#### 3. Pydantic模式
**文件**: `app/schemas/document.py`
```python
from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime

class DocumentBase(BaseModel):
    title: str
    description: Optional[str] = None
    tags: List[str] = []

class DocumentCreate(DocumentBase):
    file_name: str
    file_path: str
    file_size: int
    file_type: str

class DocumentResponse(DocumentBase):
    id: int
    created_at: datetime
    updated_at: Optional[datetime]
    
    class Config:
        from_attributes = True
```

#### 4. CRUD操作
**文件**: `app/crud/document.py`
```python
from sqlalchemy.orm import Session
from app.models.document import Document
from app.schemas.document import DocumentCreate

def create_document(db: Session, document: DocumentCreate, owner_id: int):
    db_document = Document(**document.dict(), owner_id=owner_id)
    db.add(db_document)
    db.commit()
    db.refresh(db_document)
    return db_document

def get_documents(db: Session, skip: int = 0, limit: int = 100):
    return db.query(Document).offset(skip).limit(limit).all()
```

#### 5. API路由
**文件**: `app/api/documents.py`
```python
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File
from sqlalchemy.orm import Session
from app.db.database import get_db
from app.crud import document as crud_document
from app.schemas.document import DocumentResponse, DocumentCreate

router = APIRouter(prefix="/documents", tags=["documents"])

@router.post("/", response_model=DocumentResponse)
async def create_document(
    file: UploadFile = File(...),
    title: str = Form(...),
    db: Session = Depends(get_db)
):
    # 文档创建逻辑
    return crud_document.create_document(db, document_data)
```

### 身份认证
```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
import jwt

security = HTTPBearer()

def get_current_user(token: str = Depends(security)):
    try:
        payload = jwt.decode(token.credentials, SECRET_KEY, algorithms=["HS256"])
        username = payload.get("sub")
        if username is None:
            raise HTTPException(status_code=401, detail="Invalid token")
        return get_user(username)
    except jwt.PyJWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

### 异步任务处理
```python
import asyncio
from typing import Dict, Any

class TaskManager:
    def __init__(self):
        self.tasks: Dict[str, Any] = {}
    
    async def add_task(self, task_id: str, coro):
        task = asyncio.create_task(coro)
        self.tasks[task_id] = task
        return task_id
    
    async def get_task_status(self, task_id: str):
        task = self.tasks.get(task_id)
        if not task:
            return {"status": "not_found"}
        
        if task.done():
            return {"status": "completed", "result": task.result()}
        else:
            return {"status": "running"}
```

## 📖 API文档

### 认证相关
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}

Response:
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer"
}
```

### 文档管理
```http
# 上传文档
POST /api/v1/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <file>
title: "文档标题"
description: "文档描述"
tags: "tag1,tag2"

# 获取文档列表
GET /api/v1/documents?skip=0&limit=20
Authorization: Bearer <token>

# 文档搜索
POST /api/v1/search
Authorization: Bearer <token>
Content-Type: application/json

{
  "query": "搜索关键词",
  "max_results": 20
}
```

### 错误处理
API使用标准HTTP状态码：
- `200`: 成功
- `201`: 创建成功
- `400`: 请求错误
- `401`: 未认证
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器错误

错误响应格式：
```json
{
  "detail": "错误信息描述"
}
```

## 🗄️ 数据库设计

### 表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    full_name VARCHAR(100),
    department VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    is_superuser BOOLEAN DEFAULT FALSE,
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 文档表 (documents)
```sql
CREATE TABLE documents (
    id INTEGER PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    file_name VARCHAR(255),
    file_path VARCHAR(500),
    file_size INTEGER,
    file_type VARCHAR(50),
    content TEXT,
    content_extracted BOOLEAN DEFAULT FALSE,
    tags JSON,
    status VARCHAR(20) DEFAULT 'published',
    owner_id INTEGER,
    created_at DATETIME,
    updated_at DATETIME,
    FOREIGN KEY (owner_id) REFERENCES users (id)
);
```

#### 资产表 (assets)
```sql
CREATE TABLE assets (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    asset_type VARCHAR(50),
    device_model VARCHAR(100),
    ip_address VARCHAR(45),
    hostname VARCHAR(100),
    username VARCHAR(50),
    password VARCHAR(100),
    network_location VARCHAR(50),
    department VARCHAR(50),
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    tags JSON,
    created_at DATETIME,
    updated_at DATETIME
);
```

### 索引优化
```sql
-- 文档搜索索引
CREATE INDEX idx_documents_title ON documents(title);
CREATE INDEX idx_documents_content ON documents(content);
CREATE INDEX idx_documents_owner ON documents(owner_id);

-- 资产查询索引
CREATE INDEX idx_assets_type ON assets(asset_type);
CREATE INDEX idx_assets_status ON assets(status);
CREATE INDEX idx_assets_ip ON assets(ip_address);
```

## 🧪 测试指南

### 单元测试
```python
# test_document_crud.py
import pytest
from app.crud import document as crud_document
from app.schemas.document import DocumentCreate

def test_create_document(db_session):
    document_data = DocumentCreate(
        title="测试文档",
        description="测试描述",
        file_name="test.pdf",
        file_path="/uploads/test.pdf",
        file_size=1024,
        file_type="pdf"
    )
    
    document = crud_document.create_document(db_session, document_data, owner_id=1)
    assert document.title == "测试文档"
    assert document.id is not None
```

### API测试
```python
# test_api.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_login():
    response = client.post("/api/v1/auth/login", json={
        "username": "admin",
        "password": "admin123"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()

def test_upload_document():
    # 先登录获取token
    login_response = client.post("/api/v1/auth/login", json={
        "username": "admin",
        "password": "admin123"
    })
    token = login_response.json()["access_token"]
    
    # 上传文档
    with open("test_file.pdf", "rb") as f:
        response = client.post(
            "/api/v1/upload",
            files={"file": f},
            data={"title": "测试文档"},
            headers={"Authorization": f"Bearer {token}"}
        )
    assert response.status_code == 200
```

### 前端测试
```typescript
// tests/DocumentList.spec.ts
import { mount } from '@vue/test-utils'
import DocumentList from '@/components/DocumentList.vue'

describe('DocumentList', () => {
  it('renders document list', () => {
    const wrapper = mount(DocumentList, {
      props: {
        documents: [
          { id: 1, title: '测试文档', created_at: '2024-01-01' }
        ]
      }
    })
    
    expect(wrapper.text()).toContain('测试文档')
  })
})
```

### 运行测试
```bash
# 后端测试
cd backend
pytest

# 前端测试
cd frontend
npm run test

# E2E测试
npm run test:e2e
```

## 🚀 部署指南

### 开发环境
```bash
# 启动开发服务器
npm run dev          # 前端开发服务器
python main.py       # 后端开发服务器
```

### 生产环境

#### 1. 环境配置
```bash
# 复制生产配置
cp .env.production .env
```

#### 2. 前端构建
```bash
cd frontend
npm run build
```

#### 3. 后端部署
```bash
# 使用Gunicorn部署
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker database_integrated_server:app
```

#### 4. Nginx配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /path/to/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://127.0.0.1:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Docker部署
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 8002

CMD ["uvicorn", "database_integrated_server:app", "--host", "0.0.0.0", "--port", "8002"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  backend:
    build: ./backend
    ports:
      - "8002:8002"
    volumes:
      - ./uploads:/app/uploads
      - ./data:/app/data
  
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
```

## 🤝 贡献指南

### 开发流程
1. Fork项目到个人仓库
2. 创建功能分支：`git checkout -b feature/new-feature`
3. 提交更改：`git commit -am 'Add new feature'`
4. 推送分支：`git push origin feature/new-feature`
5. 创建Pull Request

### 代码规范

#### Python代码规范
- 使用Black进行代码格式化
- 遵循PEP 8规范
- 使用类型注解
- 编写docstring文档

```python
from typing import List, Optional

def get_documents(
    skip: int = 0, 
    limit: int = 100
) -> List[Document]:
    """
    获取文档列表
    
    Args:
        skip: 跳过的记录数
        limit: 返回的记录数限制
        
    Returns:
        文档对象列表
    """
    return db.query(Document).offset(skip).limit(limit).all()
```

#### TypeScript代码规范
- 使用ESLint + Prettier
- 启用strict模式
- 使用接口定义类型
- 组件props使用类型定义

```typescript
interface DocumentProps {
  id: number
  title: string
  description?: string
  onEdit?: (id: number) => void
}

const DocumentCard: React.FC<DocumentProps> = ({ 
  id, 
  title, 
  description, 
  onEdit 
}) => {
  // 组件实现
}
```

### 提交规范
使用Conventional Commits规范：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

示例：
```
feat(document): add batch upload functionality
fix(search): resolve keyword highlighting issue
docs(api): update authentication documentation
```

### Issue和PR模板
创建Issue时请包含：
- 问题描述
- 复现步骤
- 期望行为
- 环境信息

创建PR时请包含：
- 更改说明
- 测试结果
- 相关Issue链接
- 截图（如适用）

---

*开发者文档版本: 1.0.0*
*最后更新: 2024年*